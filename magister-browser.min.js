/* Magister.js by simplyApps. Built on: 15-10-2014 */
/*
	HTTP CLASS
	======================
	
	You have to implement this with your own serverside implementation.
	Beneath here are the requirements you have to follow.

 	======================
   MINIMAL REQUIREMENTS
 	======================
 	callback: function (error, result) {...}
 	result: { content (string), headers (dictionary) }
 	options: { headers (dictionary), data (object) }
	
 	get(url, options*, callback)
 	delete(url, options*, callback)
 	post(url, data, options*, callback)
 	put(url, data, options*, callback)
	
 	* = optional (Fill with default value if null (object) ex.: options ?= {})
	
 	Class holds variable _cookie which is required to be added to the headers
*/

(function() {		 
	this.MagisterHttp = (function() {
			function MagisterHttp() {}

			MagisterHttp.prototype.get = function(url, options, callback) {

			};

			MagisterHttp.prototype["delete"] = function(url, options, callback) {

			};

			MagisterHttp.prototype.post = function(url, data, options, callback) {

			};

			MagisterHttp.prototype.put = function(url, data, options, callback) {

			};

			MagisterHttp.prototype._cookie = "";

			return MagisterHttp;

	})();
}).call(this);
(function(){var findQueries,messageFolder;this.Appointment=function(){function Appointment(_magisterObj){this._magisterObj=_magisterObj,this.id=_getset("_id"),this.begin=_getset("_begin"),this.end=_getset("_end"),this.beginBySchoolHour=_getset("_beginBySchoolHour"),this.endBySchoolHour=_getset("_endBySchoolHour"),this.fullDay=_getset("_fullDay"),this.description=_getset("_description"),this.location=_getset("_location"),this.status=_getset("_status"),this.type=_getset("_type"),this.displayType=_getset("_displayType"),this.content=_getset("_content",null,function(x){return null!=x?x.replace(/<br ?\/?>/g,"\n").replace(/(<[^>]*>)|(&nbsp;)/g,""):x}),this.infoType=_getset("_infoType"),this.notes=_getset("_notes"),this.isDone=_getset("_isDone",function(_this){return function(d){return _this._isDone!==d?(_this._isDone=d,_this._magisterObj.http.put(_this.url(),_this._toMagisterStyle(),{},function(){})):void 0}}(this)),this.classes=_getset("_classes"),this.teachers=_getset("_teachers"),this.classRooms=_getset("_classRooms"),this.groups=_getset("_groups"),this.appointmentId=_getset("_appointmentId"),this.attachments=_getset("_attachments"),this.url=_getset("_url"),this.scrapped=_getset("_scrapped"),this.absenceInfo=_getset("_absenceInfo")}return Appointment.prototype._toMagisterStyle=function(){var c,obj,p,_ref;return obj={},obj.Id=this._id,obj.Start=_helpers.toUtcString(this._begin),obj.Einde=_helpers.toUtcString(this._end),obj.LesuurVan=this._beginBySchoolHour,obj.LesuurTotMet=this._endBySchoolHour,obj.DuurtHeleDag=this._fullDay,obj.Omschrijving=this._description,obj.Lokatie=this._location,obj.Status=this._status,obj.Type=this._type,obj.WeergaveType=this._displayType,obj.Inhoud=this._content,obj.InfoType=this._infoType,obj.Aantekening=this._notes,obj.Afgerond=this._isDone,obj.Lokalen=function(){var _i,_len,_ref,_results;for(_ref=this._classRooms,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)c=_ref[_i],_results.push({Naam:c});return _results}.call(this),obj.Docenten=function(){var _i,_len,_ref,_results;for(_ref=this._teachers,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)p=_ref[_i],_results.push(p._toMagisterStyle());return _results}.call(this),obj.Vakken=function(){var _i,_len,_ref,_results;for(_ref=this._classes,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)c=_ref[_i],_results.push({Naam:c});return _results}.call(this),obj.Groepen=this._groups,obj.OpdrachtId=this._appointmentId,obj.Bijlagen=null!=(_ref=this._attachments)?_ref:[],console.log(obj),obj},Appointment.prototype._makeStorable=function(){return _.omit(this,"_magisterObj")},Appointment._convertRaw=function(magisterObj,raw){var c,obj,p;return obj=new Appointment(magisterObj),obj._id=raw.Id,obj._begin=new Date(Date.parse(raw.Start)),obj._end=new Date(Date.parse(raw.Einde)),obj._beginBySchoolHour=raw.LesuurVan,obj._endBySchoolHour=raw.LesuurTotMet,obj._fullDay=raw.DuurtHeleDag,obj._description=raw.Omschrijving,obj._location=raw.Lokatie,obj._status=raw.Status,obj._type=raw.Type,obj._displayType=raw.WeergaveType,obj._content=raw.Inhoud,obj._infoType=raw.InfoType,obj._notes=raw.Aantekening,obj._isDone=raw.Afgerond,obj._classes=null!=raw.Vakken?function(){var _i,_len,_ref,_results;for(_ref=raw.Vakken,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)c=_ref[_i],_results.push(c.Naam);return _results}():void 0,obj._teachers=null!=raw.Docenten?function(){var _i,_len,_ref,_results;for(_ref=raw.Docenten,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)p=_ref[_i],_results.push(Person._convertRaw(magisterObj,p));return _results}():void 0,obj._classRooms=null!=raw.Lokalen?function(){var _i,_len,_ref,_results;for(_ref=raw.Lokalen,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)c=_ref[_i],_results.push(c.Naam);return _results}():void 0,obj._groups=raw.Groepen,obj._appointmentId=raw.OpdrachtId,obj._attachments=raw.Bijlagen,obj._url=""+magisterObj._personUrl+"/afspraken/"+obj._id,obj._scrapped=0===raw.Status,obj},Appointment._convertStored=function(magisterObj,raw){var obj;return obj=_.extend(raw,new Appointment(magisterObj)),obj._magisterObj=magisterObj,obj._begin=new Date(Date.parse(raw._begin)),obj._end=new Date(Date.parse(raw._end)),obj},Appointment}(),this.Assignment=function(){function Assignment(_magisterObj){this._magisterObj=_magisterObj,this.id=_getset("_id"),this.name=_getset("_name"),this.description=_getset("_description"),this["class"]=_getset("_class"),this.deadline=_getset("_deadline"),this.handedInOn=_getset("_handedInOn"),this.files=_getset("_files"),this.teachers=_getset("_teachers"),this.grade=_getset("_grade"),this.markedOn=_getset("_markedOn"),this.handInAgain=_getset("_handInAgain"),this.finished=_getset("_finished"),this.canHandIn=_getset("_canHandIn")}return Assignment.prototype.versions=function(callback){var id,pushResult,_i,_len,_ref,_results;for(pushResult=_helpers.asyncResultWaiter(this._versionIds.length,function(r){return callback(null,r)}),_ref=this._versionIds,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)id=_ref[_i],_results.push(this._magisterObj.http.get(""+this._magisterObj._personUrl+"/opdrachten/versie/"+id,{},function(_this){return function(error,result){return null!=error?callback(error,null):pushResult(AssignmentVersion._convertRaw(_this._magisterObj,_this,EJSON.parse(result.content)))}}(this)));return _results},Assignment._convertRaw=function(magisterObj,raw){var f,obj,p,v;return obj=new Assignment(magisterObj),obj._id=raw.Id,obj._name=raw.Titel,obj._description=raw.Omschrijving,obj._class=raw.Vak,obj._deadline=new Date(Date.parse(raw.InleverenVoor)),obj._handedInOn=new Date(Date.parse(raw.IngeleverdOp)),obj._files=function(){var _i,_len,_ref,_results;for(_ref=raw.Bijlagen,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)f=_ref[_i],_results.push(File._convertRaw(magisterObj,void 0,f));return _results}(),obj._teachers=null!=raw.Docenten?function(){var _i,_len,_ref,_results;for(_ref=raw.Docenten,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)p=_ref[_i],_results.push(Person._convertRaw(magisterObj,p));return _results}():void 0,obj._versionIds=function(){var _i,_len,_ref,_results;for(_ref=raw.VersieNavigatieItems,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)v=_ref[_i],_results.push(v.Id);return _results}(),obj._grade=raw.Beoordeling,obj._markedOn=new Date(Date.parse(raw.BeoordeeldOp)),obj._handInAgain=raw.OpnieuwInleveren,obj._finished=raw.Afgesloten,obj._canHandIn=raw.MagInleveren,obj},Assignment}(),this.AssignmentVersion=function(){function AssignmentVersion(_magisterObj){this._magisterObj=_magisterObj,this.id=_getset("_id"),this["class"]=_getset("_class"),this.state=_getset("_state"),this.pupilMessage=_getset("_pupilMessage"),this.teacherNotice=_getset("_teacherNotice"),this.handedInFiles=_getset("_handedInFiles"),this.feedbackFiles=_getset("_feedbackFiles"),this.deadline=_getset("_deadline"),this.handedInOn=_getset("_handedInOn"),this.grade=_getset("_grade"),this.markedOn=_getset("_markedOn"),this.version=_getset("_version"),this.tooLate=_getset("_tooLate")}return AssignmentVersion._convertRaw=function(magisterObj,sender,raw){var f,obj;return obj=new AssignmentVersion(magisterObj),obj._id=raw.Id,obj._class=sender._class,obj._state=raw.Status,obj._pupilMessage=raw.LeerlingOpmerking,obj._teacherNotice=raw.DocentOpmerking,obj._handedInFiles=function(){var _i,_len,_ref,_results;for(_ref=raw.LeerlingBijlagen,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)f=_ref[_i],_results.push(File._convertRaw(magisterObj,void 0,f));return _results}(),obj._feedbackFiles=function(){var _i,_len,_ref,_results;for(_ref=raw.FeedbackBijlagen,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)f=_ref[_i],_results.push(File._convertRaw(magisterObj,void 0,f));return _results}(),obj._deadline=new Date(Date.parse(raw.InleverenVoor)),obj._handedInOn=new Date(Date.parse(raw.IngeleverdOp)),obj._grade=raw.Beoordeling,obj._markedOn=new Date(Date.parse(raw.BeoordeeldOp)),obj._version=raw.VersieNummer,obj._tooLate=raw.IsTeLaat,obj},AssignmentVersion}(),this.Class=function(){function Class(_magisterObj){this._magisterObj=_magisterObj,this.id=_getset("_id"),this.beginDate=_getset("_beginDate"),this.endDate=_getset("_endDate"),this.licenseUrl=_getset("_licenseUrl"),this.abbreviation=_getset("_abbreviation"),this.description=_getset("_description"),this.number=_getset("_number")}return Class._convertRaw=function(magisterObj,raw){var obj;return obj=new Class(magisterObj),obj._id=raw.Id,obj._beginDate=new Date(Date.parse(raw.Begindatum)),obj._endDate=new Date(Date.parse(raw.Einddatum)),obj._licenseUrl=raw.LicentieUrl,obj._abbreviation=raw.Afkorting,obj._description=raw.Omschrijving,obj._number=raw.Volgnr,obj},Class}(),this.Course=function(){function Course(_magisterObj){this._magisterObj=_magisterObj,this.id=_getset("_id"),this.begin=_getset("_begin"),this.end=_getset("_end"),this.schoolPeriod=_getset("_schoolPeriod"),this.type=_getset("_type"),this.group=_getset("_group"),this.profile=_getset("_profile"),this.alternativeProfile=_getset("_alternativeProfile")}return Course.prototype.classes=function(callback){return this._magisterObj.http.get(this._classesUrl,{},function(_this){return function(error,result){var c;return null!=error?callback(error,null):callback(null,function(){var _i,_len,_ref,_results;for(_ref=EJSON.parse(result.content).Items,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)c=_ref[_i],_results.push(Class._convertRaw(this._magisterObj,c));return _results}.call(_this))}}(this))},Course.prototype.grades=function(){var callback,download,_ref;if(download=null!=(_ref=_.find(arguments,function(a){return _.isBoolean(a)}))?_ref:!0,callback=_.find(arguments,function(a){return _.isFunction(a)}),null==callback)throw new Error("Callback can't be null");return this._magisterObj.http.get(this._gradesUrl,{},function(_this){return function(error,result){var g,pushResult,_i,_len,_results;if(null!=error)return callback(error,null);for(result=EJSON.parse(result.content).Items,pushResult=_helpers.asyncResultWaiter(result.length,function(r){return callback(null,r)}),_results=[],_i=0,_len=result.length;_len>_i;_i++)g=result[_i],_results.push(function(g){return g.teacher=Person._convertRaw(_this._magisterObj,{Docentcode:g.Docent}),g.teacher._type=3,download?_this._magisterObj.getPersons(g.Docent,3,function(e,r){var teacher;return null==e&&null!=r[0]&&(teacher=r[0]),pushResult(Grade._convertRaw(g))}):pushResult(Grade._convertRaw(g))}(g));return _results}}(this))},Course._convertRaw=function(magisterObj,raw){var obj;return obj=new Course(magisterObj),obj._classesUrl=magisterObj.magisterSchool.url+_.find(raw.Links,{Rel:"Vakken"}).Href,obj._gradesUrl=magisterObj._personUrl+("/aanmeldingen/"+raw.Id+"/cijfers/cijferoverzichtvooraanmelding?actievePerioden=true&alleenBerekendeKolommen=false&alleenPTAKolommen=false"),obj._id=raw.Id,obj._begin=new Date(Date.parse(raw.Start)),obj._end=new Date(Date.parse(raw.Einde)),obj._schoolPeriod=raw.Lesperiode,obj._type={id:raw.Studie.Id,description:raw.Studie.Omschrijving},obj._group={id:raw.Groep.Id,description:raw.Groep.Omschrijving,locationId:raw.Groep.LocatieId},obj._profile=raw.Profiel,obj._alternativeProfile=raw.Profiel2,obj},Course}(),this.DigitalSchoolUtility=function(){function DigitalSchoolUtility(_magisterObj){this._magisterObj=_magisterObj,this.id=_getset("_id"),this.type=_getset("_type"),this.name=_getset("_name"),this.publisher=_getset("_publisher"),this.state=_getset("_state"),this.begin=_getset("_begin"),this.end=_getset("_end"),this.EAN=_getset("_EAN"),this.url=_getset("_url"),this["class"]=_getset("_class")}return DigitalSchoolUtility._convertRaw=function(magisterObj,raw){var obj;return obj=new DigitalSchoolUtility(magisterObj),obj._id=raw.Id,obj._type=raw.MateriaalType,obj._name=raw.Titel,obj._publisher=raw.Uitgeverij,obj._state=raw.Status,obj._begin=new Date(Date.parse(raw.Start)),obj._end=new Date(Date.parse(raw.Eind)),obj._EAN=Number(raw.EAN),obj._url=raw.Url,obj._class=raw.Vak,obj},DigitalSchoolUtility}(),this.FileFolder=function(){function FileFolder(_magisterObj){this._magisterObj=_magisterObj,this.id=_getset("_id"),this.name=_getset("_name"),this.rights=_getset("_rights"),this.parentId=_getset("_parentId")}return FileFolder.prototype.files=function(callback){return this._magisterObj.http.get(""+this._magisterObj._personUrl+"/bronnen?parentId="+this.id(),{},function(_this){return function(error,result){var f,files,pushResult,_i,_len,_results;if(null!=error)return callback(error,null);for(files=function(){var _i,_len,_ref,_results;for(_ref=EJSON.parse(result.content).Items,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)f=_ref[_i],_results.push(File._convertRaw(this._magisterObj,this,f));return _results}.call(_this),pushResult=_helpers.asyncResultWaiter(files.length,function(){return callback(null,files)}),_results=[],_i=0,_len=files.length;_len>_i;_i++)f=files[_i],_results.push(function(f){return _this._magisterObj.getPersons(f.GeplaatstDoor,function(e,r){return null==e&&0!==r.length&&(f._addedBy=r[0]),pushResult()})}(f));return _results}}(this))},FileFolder._convertRaw=function(magisterObj,raw){var obj;return obj=new FileFolder(magisterObj),obj._id=raw.Id,obj._name=raw.Naam,obj._rights=raw.Privilege,obj._parentId=raw.ParentId,obj},FileFolder}(),this.File=function(){function File(_magisterObj){this._magisterObj=_magisterObj,this.id=_getset("_id"),this.type=_getset("_type"),this.name=_getset("_name",function(_this){return function(x){return _this._name=x,_this._update()}}(this)),this.uri=_getset("_uri"),this.size=_getset("_size"),this.rights=_getset("_rights"),this.mime=_getset("_mime"),this.changedDate=_getset("_changedDate"),this.creationDate=_getset("_creationDate"),this.addedBy=_getset("_addedBy"),this.fileBlobId=_getset("_fileBlobId"),this.fileFolder=_getset("_fileFolder",this.move),this.uniqueId=_getset("_uniqueId")}return File.prototype.download=function(){var callback,downloadFile,_ref;return callback=_.find(arguments,function(a){return _.isFunction(a)}),downloadFile=null!=(_ref=_.find(arguments,function(a){return _.isBoolean(a)}))?_ref:!0,this._magisterObj.http.get(this._downloadUrl,{},function(_this){return function(error,result){var data;return null!=error?callback(error,null):(data=result.content,downloadFile&&_helpers.saveFile(data,_this.mime(),_this.name()),"function"==typeof callback?callback(null,data):void 0)}}(this))},File.prototype.move=function(fileFolder){return this._magisterObj.fileFolders(function(_this){return function(e,r){if(null!=e)throw e;return _.isObject(fileFolder)||(fileFolder=_.find(r,function(f){return _helpers.contains(f.name(),fileFolder,!0)||f.id()===fileFolder})),_this._fileFolder=fileFolder,_this._update()}}(this))},File.prototype.remove=function(){return this._magisterObj.http["delete"](""+this._magisterObj._personUrl+"/bronnen/"+this.id(),{},function(error){if(null!=error)throw error})},File.prototype._update=function(){return this._magisterObj.http.put(""+this._magisterObj._personUrl+"/bronnen/"+this.id(),this._toMagisterStyle(),{},function(){})},File.prototype._toMagisterStyle=function(){var obj;return obj={},obj.Id=this._id,obj.BronSoort=this._type,obj.Naam=this._name,obj.Uri=this._uri,obj.Grootte=this._size,obj.Privilege=this._rights,obj.ContentType=this._mime,obj.FileBlobId=this._fileBlobId,obj.ParentId=this._fileFolder.id(),obj.UniqueId=this._uniqueId,obj},File._convertRaw=function(magisterObj,sender,raw){var addedBy,obj,_ref;return null!=raw._addedBy?addedBy=raw._addedBy:(addedBy=new Person(magisterObj,null,"",""),addedBy._fullName=raw.GeplaatstDoor),obj=new File(magisterObj),obj._id=raw.Id,obj._type=raw.BronSoort,obj._name=raw.Naam,obj._uri=raw.Uri,obj._size=raw.Grootte,obj._rights=raw.Privilege,obj._mime=raw.ContentType,obj._changedDate=new Date(Date.parse(raw.GewijzigdOp)),obj._creationDate=new Date(Date.parse(null!=(_ref=raw.GemaaktOp)?_ref:raw.Datum)),obj._addedBy=addedBy,obj._fileBlobId=raw.FileBlobId,obj._fileFolder=sender,obj._uniqueId=raw.UniqueId,obj._downloadUrl=magisterObj.magisterSchool.url+_.find(raw.Links,{Rel:"Contents"}).Href,obj},File}(),this.Grade=function(){function Grade(_magisterObj){this._magisterObj=_magisterObj,this.id=_getset("_id"),this.grade=_getset("_grade"),this.passed=_getset("_passed"),this.dateFilledIn=_getset("_dateFilledIn"),this.gradePeriod=_getset("_gradePeriod"),this["class"]=_getset("_class"),this.atLaterDate=_getset("_atLaterDate"),this.exemption=_getset("_exemption"),this.counts=_getset("_counts"),this.type=_getset("_type"),this.teacher=_getset("_teacher"),this.classExemption=_getset("_classExemption")}return Grade._convertRaw=function(magisterObj,raw){var obj;return obj=new Grade(magisterObj),obj._id=raw.CijferId,obj._grade=raw.CijferStr,obj._passed=raw.IsVoldoende,obj._dateFilledIn=new Date(Date.parse(raw.DatumIngevoerd)),obj._gradePeriod={id:function(){return raw.CijferPeriode.Id},abbreviation:function(){return raw.CijferPeriode.Afkorting}},obj._class={id:function(){return raw.Vak.Id},abbreviation:function(){return raw.Vak.Afkorting},description:function(){return raw.Vak.Omschrijving}},obj._atLaterDate=raw.Inhalen,obj._exemption=raw.Vrijstelling,obj._counts=raw.TeltMee,obj._type=GradeType._convertRaw(raw.CijferKolom),obj._assignmentId=raw.CijferKolomIdEloOpdracht,obj._teacher=raw.teacher,obj._classExemption=raw.VakDispensatie||raw.VakVrijstelling,obj},Grade}(),this.GradeType=function(){function GradeType(_magisterObj){this._magisterObj=_magisterObj,this.id=_getset("_id"),this.name=_getset("_name"),this.number=_getset("_number"),this.header=_getset("_header"),this.description=_getset("_description"),this.type=_getset("_type"),this.isAtLaterDate=_getset("_isAtLaterDate"),this.isTeacher=_getset("_isTeacher"),this.hasNestedTypes=_getset("_hasNestedTypes"),this.isPTA=_getset("_isPTA")}return GradeType._convertRaw=function(magisterObj,raw){var obj;return obj=new GradeType(magisterObj),obj._id=raw.Id,obj._name=raw.KolomNaam,obj._number=raw.KolomNummer,obj._header=raw.KolomKop,obj._description=raw.KolomOmschrijving,obj._type=raw.KolomSoort,obj._isAtLaterDate=raw.IsHerkansingKolom,obj._isTeacher=raw.IsDocentKolom,obj._hasNestedTypes=raw.HeeftOndeliggendeKolommen,obj._isPTA=raw.IsPTAKolom,obj},GradeType}(),this.Magister=function(){function Magister(magisterSchool,username,password,_keepLoggedIn){if(this.magisterSchool=magisterSchool,this.username=username,this.password=password,this._keepLoggedIn=null!=_keepLoggedIn?_keepLoggedIn:!0,3!==arguments.length&&4!==arguments.length)throw new Error("Expected 3 or 4 arguments, got "+arguments.length);this._readyCallbacks=[],this.http=new MagisterHttp,this.reLogin()}return Magister.prototype.appointments=function(){var callback,dateConvert,download,from,to,url,_ref,_ref1;return callback=_.find(arguments,function(a){return _.isFunction(a)}),download=null!=(_ref=_.find(arguments,function(a){return _.isBoolean(a)}))?_ref:!0,_ref1=_.where(arguments,function(a){return _.isDate(a)}),from=_ref1[0],to=_ref1[1],null==to&&(to=from),this._forceReady(),dateConvert=_helpers.urlDateConvert,url=""+this._personUrl+"/afspraken?tot="+dateConvert(to)+"&van="+dateConvert(from),this.http.get(url,{},function(_this){return function(error,result){var a,absences,appointments,hit,pushResult,_i,_len,_results;if(null!=error)return callback(error,null);if(result=EJSON.parse(result.content),appointments=function(){var _i,_len,_ref2,_results;for(_ref2=result.Items,_results=[],_i=0,_len=_ref2.length;_len>_i;_i++)a=_ref2[_i],_results.push(Appointment._convertRaw(this,a));return _results}.call(_this),absences=[],hit=_helpers.asyncResultWaiter(3,function(){var _fn,_i,_len;for(_fn=function(a){return a._absenceInfo=_.find(absences,function(absence){return absence.appointmentId===a.id()})},_i=0,_len=appointments.length;_len>_i;_i++)a=appointments[_i],_fn(a);return _.remove(appointments,function(a){return _helpers.date(a.begin())<_helpers.date(from)||_helpers.date(a.end())>_helpers.date(to)}),callback(null,_.sortBy(appointments,function(x){return x.begin()}))}),_this.http.get(""+_this._personUrl+"/roosterwijzigingen?tot="+dateConvert(to)+"&van="+dateConvert(from),{},function(error,result){var c;return appointments=_helpers.pushMore(appointments,function(){var _i,_len,_ref2,_results;for(_ref2=EJSON.parse(result.content).Items,_results=[],_i=0,_len=_ref2.length;_len>_i;_i++)c=_ref2[_i],_results.push(Appointment._convertRaw(this,c));return _results}.call(_this)),hit()}),_this.http.get(""+_this._personUrl+"/absenties?tot="+dateConvert(to)+"&van="+dateConvert(from),{},function(error,result){var _fn,_i,_len;for(result=EJSON.parse(result.content).Items,_fn=function(a){return absences.push({id:a.Id,begin:new Date(Date.parse(a.Start)),end:new Date(Date.parse(a.Eind)),schoolHour:a.Lesuur,permitted:a.Geoorloofd,appointmentId:a.AfspraakId,description:_helpers.trim(a.Omschrijving),type:a.VerantwoordingType,code:a.Code})},_i=0,_len=result.length;_len>_i;_i++)a=result[_i],_fn(a);return hit()}),download){for(pushResult=_helpers.asyncResultWaiter(appointments.length,function(){return hit()}),_results=[],_i=0,_len=appointments.length;_len>_i;_i++)a=appointments[_i],_results.push(function(a){var teachers,_ref2;return teachers=null!=(_ref2=a.teachers())?_ref2:[],_this.fillPersons(teachers,function(e,r){return a._teachers=r,pushResult()},3)}(a));return _results}return hit()}}(this))},Magister.prototype.messageFolders=function(query,callback){var result;return this._forceReady(),null==callback&&(callback=function(){}),result=_.isString(query)&&""!==query?_.where(this._messageFolders,function(mF){return _helpers.contains(mF.name(),query,!0)}):this._messageFolders,callback(null,result),result},Magister.prototype.inbox=function(callback){return null==callback&&(callback=function(){}),this.messageFolders("postvak in",function(error,result){return null!=error?callback(error,null):callback(null,result[0])})[0]},Magister.prototype.sentItems=function(callback){return null==callback&&(callback=function(){}),this.messageFolders("verzonden items",function(error,result){return null!=error?callback(error,null):callback(null,result[0])})[0]},Magister.prototype.bin=function(callback){return null==callback&&(callback=function(){}),this.messageFolders("verwijderde items",function(error,result){return null!=error?callback(error,null):callback(null,result[0])})[0]},Magister.prototype.alerts=function(callback){return null==callback&&(callback=function(){}),this.messageFolders("mededelingen",function(error,result){return null!=error?callback(error,null):callback(null,result[0])})[0]},Magister.prototype.courses=function(callback){var url;return this._forceReady(),url=""+this._personUrl+"/aanmeldingen",this.http.get(url,{},function(_this){return function(error,result){var c;return null!=error?callback(error,null):(result=EJSON.parse(result.content),callback(null,_.sortBy(function(){var _i,_len,_ref,_results;for(_ref=result.Items,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)c=_ref[_i],_results.push(Course._convertRaw(this,c));return _results}.call(_this),function(c){return c.begin()})))}}(this))},Magister._cachedPersons={},Magister.prototype.getPersons=function(){var callback,query,type,url,val;return this._forceReady(),query=_helpers.trim(arguments[0]),callback=2===arguments.length?arguments[1]:arguments[2],3===arguments.length&&(type=arguments[1]),null!=query&&null!=callback&&query.length>=3?null==type?void this.getPersons(query,3,function(_this){return function(e,r){return null!=e?callback(e,null):0!==r.length?callback(null,r):_this.getPersons(query,4,function(e,r){return null!=e?callback(e,null):callback(null,r)})}}(this)):(type=function(){switch(Person._convertType(type)){case 1:return"Groep";case 3:return"Docent";case 4:return"Leerling";case 8:return"Project";default:return"Overig"}}(),url=""+this._personUrl+"/contactpersonen?contactPersoonType="+type+"&q="+query,null!=(val=Magister._cachedPersons[""+this._id+type+query])?callback(null,val):this.http.get(url,{},function(_this){return function(error,result){var p;return null!=error?callback(error,null):(result=function(){var _i,_len,_ref,_results;for(_ref=EJSON.parse(result.content).Items,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)p=_ref[_i],_results.push(Person._convertRaw(this,p));return _results}.call(_this),Magister._cachedPersons[""+_this._id+type+query]=result,callback(null,result))}}(this))):void callback(null,[])},Magister.prototype.fillPersons=function(persons,callback,overwriteType){var p,pushResult,_i,_len,_ref,_ref1;if(_.isArray(persons)){if(0===persons.length)return void callback(null,[]);for(pushResult=_helpers.asyncResultWaiter(persons.length,function(r){return callback(null,r)}),_i=0,_len=persons.length;_len>_i;_i++){p=persons[_i];try{this.getPersons(_.last(p.fullName().split(" ")),null!=(_ref=p._type)?_ref:overwriteType,function(e,r){var _ref1;if(null!=e||null==r)throw e;return pushResult(null!=(_ref1=r[0])?_ref1:p)})}catch(_error){pushResult(p)}}}else{if(!_.isObject(persons))throw new Error("Expected persons to be an Array or an Object, got a(n) "+typeof persons);try{this.getPersons(_.last(persons.fullName().split(" ")),null!=(_ref1=persons._type)?_ref1:overwriteType,function(e,r){var _ref2;if(null!=e||null==r)throw e;return callback(null,null!=(_ref2=r[0])?_ref2:persons)})}catch(_error){callback(persons)}}return void 0},Magister.prototype.composeAndSendMessage=function(){var body,m,recipients,subject,_ref;return _ref=_.filter(arguments,function(a){return _.isString(a)}),subject=_ref[0],body=_ref[1],recipients=_.find(arguments,function(a){return!_.isString(a)}),m=new Message(this),m.subject(subject),m.body(null!=body?body:""),m.addRecipient(recipients),m.send()},Magister.prototype.fileFolders=function(callback){return this.http.get(""+this._personUrl+"/bronnen?soort=0",{},function(_this){return function(error,result){var f;return null!=error?callback(error,null):callback(null,function(){var _i,_len,_ref,_results;for(_ref=EJSON.parse(result.content).Items,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)f=_ref[_i],_results.push(FileFolder._convertRaw(this,f));return _results}.call(_this))}}(this))},Magister.prototype.studyGuides=function(callback){return this.http.get(""+this._pupilUrl+"/studiewijzers?peildatum="+_helpers.urlDateConvert(new Date),{},function(_this){return function(error,result){var s;return null!=error?callback(error,null):callback(null,function(){var _i,_len,_ref,_results;for(_ref=EJSON.parse(result.content).Items,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)s=_ref[_i],_results.push(StudyGuide._convertRaw(this,s));return _results}.call(_this))}}(this))},Magister.prototype.assignments=function(){var amount,callback,classes,download,skip,_ref;return _ref=_.filter(arguments,function(a){return _.isNumber(a)}),amount=_ref[0],skip=_ref[1],download=_.find(arguments,function(a){return _.isBoolean(a)}),callback=_.find(arguments,function(a){return _.isFunction(a)}),null!=callback?(null==download&&(download=!0),null==amount&&(amount=25),null==skip&&(skip=0),classes=null,this.courses(function(_this){return function(e,r){return null!=r&&0!==r.length&&_.last(r).classes(function(e,r){return null!=r&&0!==r.length?classes=r:void 0}),_this.http.get(""+_this._personUrl+"/opdrachten?skip=0&top=25&startdatum="+_helpers.urlDateConvert(new Date)+"&status=alle",{},function(error,result){var id,pushResult,_i,_len,_results;if(null!=error)return callback(error,null);for(result=function(){var _i,_len,_ref1,_results;for(_ref1=EJSON.parse(result.content).Items,_results=[],_i=0,_len=_ref1.length;_len>_i;_i++)e=_ref1[_i],_results.push(e.Id);return _results}(),pushResult=_helpers.asyncResultWaiter(result.length,function(r){return callback(null,r)}),_results=[],_i=0,_len=result.length;_len>_i;_i++)id=result[_i],_results.push(_this.http.get(""+_this._personUrl+"/opdrachten/"+id,{},function(error,result){var assignment,teachers,_ref1;return assignment=Assignment._convertRaw(_this,EJSON.parse(result.content)),null!=classes&&(assignment._class=_.find(classes,function(c){return c.abbreviation()===assignment._class})),download?(teachers=null!=(_ref1=assignment.teachers())?_ref1:[],_this.fillPersons(teachers,function(e,r){return assignment._teachers=r,pushResult(assignment)},3)):pushResult(assignment)}));return _results})}}(this))):void 0},Magister.prototype.digitalSchoolUtilities=function(){var callback,classes,url,_class;return callback=_.find(arguments,function(a){return _.isFunction(a)}),null!=callback?(_.isObject(_class)&&(_class=_class.id()),url=null!=_class?""+this._personUrl+"/lesmateriaal?vakken="+_class:""+this._personUrl+"/lesmateriaal",classes=null,this.courses(function(_this){return function(e,r){return null!=r&&0!==r.length&&_.last(r).classes(function(e,r){return null!=r&&0!==r.length?classes=r:void 0}),_this.http.get(url,{},function(error,result){var u,utilities,_fn,_i,_len;if(null!=error)return callback(error,null);if(utilities=function(){var _i,_len,_ref,_results;for(_ref=EJSON.parse(result.content).Items,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)u=_ref[_i],_results.push(DigitalSchoolUtility._convertRaw(this,u));return _results}.call(_this),null!=classes)for(_fn=function(u){return u._class=_.find(classes,function(c){return c.abbreviation()===u._class.Afkorting&&c.description()===u._class.Omschrijving})},_i=0,_len=utilities.length;_len>_i;_i++)u=utilities[_i],_fn(u);return callback(null,utilities)})}}(this))):void 0},Magister.prototype.profileInfo=function(callback){return this._forceReady(),"function"==typeof callback&&callback(null,this._profileInfo),this._profileInfo},Magister.prototype.ready=function(callback){return _.isFunction(callback)&&(this._ready?callback(this):this._readyCallbacks.push(callback)),this._ready===!0},Magister.prototype._forceReady=function(){if(!this._ready)throw new Error("Not done with logging in! (use Magister.ready(callback) to be sure that logging in is done)")},Magister.prototype._setReady=function(){var callback,_i,_len,_ref;for(this._ready=!0,_ref=this._readyCallbacks,_i=0,_len=_ref.length;_len>_i;_i++)(callback=_ref[_i])(this);return this._readyCallbacks=[]},Magister.prototype._readyCallbacks=[],Magister.prototype.reLogin=function(){var url;return this._ready=!1,url=""+this.magisterSchool.url+"/api/sessie",this.http.post(url,{Gebruikersnaam:this.username,Wachtwoord:this.password,GebruikersnaamOnthouden:!0,IngelogdBlijven:this._keepLoggedIn},{headers:{"Content-Type":"application/json;charset=UTF-8"}},function(_this){return function(error,result){if(null!=error)throw new Error(error.message);return _this._sessionId=/[a-z\d-]+/.exec(result.headers["set-cookie"][0])[0],_this.http._cookie="SESSION_ID="+_this._sessionId+"; M6UserName="+_this.username,_this.http.get(""+_this.magisterSchool.url+"/api/account",{},function(error,result){return result=EJSON.parse(result.content),_this._group=result.Groep[0],_this._id=result.Persoon.Id,_this._personUrl=""+_this.magisterSchool.url+"/api/personen/"+_this._id,_this._pupilUrl=""+_this.magisterSchool.url+"/api/leerlingen/"+_this._id,_this._profileInfo=ProfileInfo._convertRaw(_this,result),_this.http.get(""+_this._personUrl+"/berichten/mappen",{},function(error,result){var m;return _this._messageFolders=function(){var _i,_len,_ref,_results;for(_ref=EJSON.parse(result.content).Items,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)m=_ref[_i],_results.push(MessageFolder._convertRaw(this,m));return _results}.call(_this),_this._setReady()})})}}(this))},Magister}(),messageFolder=function(magisterObj,x){switch(x){case 1:return magisterObj.inbox();case 2:return magisterObj.sentItems();case 3:return magisterObj.bin();case 4:return magisterObj.alerts();default:return MessageFolder._convertRaw({Id:x})}},this.Message=function(){function Message(_magisterObj){if(this._magisterObj=_magisterObj,null==this._magisterObj)throw new Error("Magister instance is null!");this._canSend=!0,this._sender=this._magisterObj.profileInfo(),this._recipients=[],this._sendDate=new Date,this._isRead=!1,this._type=1,this._subject="",this._body="",this.id=_getset("_id"),this.body=_getset("_body",function(_this){return function(x){return _this._body=x}}(this),function(x){return null!=x?x.replace(/<br ?\/?>/g,"\n").replace(/(<[^>]*>)|(&nbsp;)/g,""):x
}),this.attachments=_getset("_attachments"),this.messageFolder=_getset("_folderId",function(_this){return function(x){return _this.move(x)}}(this),function(_this){return function(x){return messageFolder(_this._magisterObj,x)}}(this)),this.subject=_getset("_subject",function(_this){return function(x){return _this._subject=x}}(this)),this.sender=_getset("_sender"),this.recipients=_getset("_recipients"),this.sendDate=_getset("_sendDate"),this.begin=_getset("_begin"),this.end=_getset("_end"),this.isRead=_getset("_isRead",function(_this){return function(x){return _this._isRead!==x?(_this._isRead=x,_this._magisterObj.http.put(""+_magisterObj._personUrl+"/berichten/"+_this.id()+"?berichtSoort="+type(),_this._toMagisterStyle(),{},function(){})):void 0}}(this)),this.state=_getset("_state"),this.isFlagged=_getset("_isFlagged"),this.type=_getset("_type")}return Message.prototype._tasks=0,Message.prototype._sendAfterFinished=!1,Message.prototype._working=function(){return 0!==this._tasks},Message.prototype._tickDown=function(){return 0===--this._tasks&&this._sendAfterFinished?this.send():void 0},Message.prototype._reset=function(){return this._tasks=0,this._sendAfterFinished=!1},Message.prototype.addRecipient=function(recipient,type){var p,_i,_len;if(_.isString(recipient))this._tasks++,this._magisterObj.getPersons(recipient,type,function(_this){return function(e,r){if(0!==r.length)return _this.recipients().push(r[0]),_this._tickDown();throw null!=type?(_this._reset(),new Error("Couldn't find a person with the type: \""+type+'" and with the query: "'+recipient+'"')):(_this._reset(),new Error("Couldn't find a person with the query: \""+recipient+'"'))}}(this));else if(_.isArray(recipient))for(_i=0,_len=recipient.length;_len>_i;_i++)p=recipient[_i],this.addRecipient(p,type);else{if(!_.isObject(recipient))throw this._reset(),new Error("Expected recipient to be a String or an Object, got a(n) "+typeof recipient);this.recipients().push(recipient)}return void 0},Message.prototype.send=function(){if(this._working())return this._sendAfterFinished=!0,!1;if(!this._canSend)throw new Error("This message is marked as unsendable");if(null==this.recipients()||!this.sender())throw new Error("Sender and/or recipients cannot be null");if(null!=this.body())throw new Error("Body cannot be null");if(null==this.subject()||0===this.subject().length)throw new Error("Subject cannot be null or empty");return this._magisterObj.http.post(""+this._magisterObj._personUrl+"/berichten",this._toMagisterStyle(),{},function(e){if(null!=e)throw e}),!0},Message.prototype.move=function(){},Message.prototype._toMagisterStyle=function(){var obj,p;return obj={},obj.Id=this._id,obj.Inhoud=this._body,obj.MapId=this._folderId,obj.Onderwerp=this._subject,obj.Ontvangers=function(){var _i,_len,_ref,_results;for(_ref=this._recipients,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)p=_ref[_i],_results.push(p._toMagisterStyle());return _results}.call(this),obj.VerstuurdOp=this._sendDate,obj.Begin=this._begin,obj.Einde=this._end,obj.IsGelezen=this._isRead,obj.Status=this._state,obj.HeeftPrioriteit=this._isFlagged,obj.Soort=this._type,obj},Message._convertRaw=function(magisterObj,raw){var a,o,obj;return obj=new Message(magisterObj),obj._id=raw.Id,obj._body=raw.Inhoud,obj._attachments=function(){var _i,_len,_ref,_ref1,_results;for(_ref1=null!=(_ref=raw.Bijlagen)?_ref:[],_results=[],_i=0,_len=_ref1.length;_len>_i;_i++)a=_ref1[_i],_results.push(Attachment._convertRaw(magisterObj,a));return _results}(),obj._folderId=raw.MapId,obj._subject=raw.Onderwerp,obj._sender=Person._convertRaw(magisterObj,raw.Afzender),obj._recipients=function(){var _i,_len,_ref,_results;for(_ref=raw.Ontvangers,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)o=_ref[_i],_results.push(Person._convertRaw(magisterObj,o));return _results}(),obj._sendDate=new Date(Date.parse(raw.VerstuurdOp)),obj._begin=new Date(Date.parse(raw.Begin)),obj._end=new Date(Date.parse(raw.Einde)),obj._isRead=raw.IsGelezen,obj._state=raw.Status,obj._isFlagged=raw.HeeftPrioriteit,obj._type=raw.Soort,obj._canSend=!1,obj},Message}(),findQueries=function(queries){var final,numbers,result;return final="",_.any(["unread","ongelezen"],function(x){return _helpers.contains(queries,x,!0)})?final+="&gelezen=false":_.any(["read","gelezen"],function(x){return _helpers.contains(queries,x,!0)})&&(final+="&gelezen=true"),null!=(result=/(skip \d+)|(sla \d+ over)/gi.exec(queries))&&(numbers=/\d+/.exec(result[0])[0],final+="&skip="+numbers),final},this.MessageFolder=function(){function MessageFolder(_magisterObj){this._magisterObj=_magisterObj,this.name=_getset("_name"),this.unreadMessagesCount=_getset("_unreadMessagesCount"),this.id=_getset("_id"),this.parentId=_getset("_parentId")}return MessageFolder.prototype.messages=function(){var callback,download,limit,queries,url,_ref,_ref1,_ref2;if(limit=null!=(_ref=_.find(arguments,function(a){return _.isNumber(a)}))?_ref:10,queries=null!=(_ref1=_.find(arguments,function(a){return _.isString(a)}))?_ref1:"",download=null!=(_ref2=_.find(arguments,function(a){return _.isBoolean(a)}))?_ref2:!0,callback=_.find(arguments,function(a){return _.isFunction(a)}),null==callback)throw new Error("Callback is null");return 0===limit?void callback(null,[]):(url=""+this._magisterObj._personUrl+"/berichten?mapId="+this.id()+"&top="+limit+findQueries(queries),this._magisterObj.http.get(url,{},function(_this){return function(error,result){var m,messages,pushMessage,_i,_len,_results;if(null!=error)return callback(error,null);for(messages=function(){var _i,_len,_ref3,_results;for(_ref3=EJSON.parse(result.content).Items,_results=[],_i=0,_len=_ref3.length;_len>_i;_i++)m=_ref3[_i],_results.push(Message._convertRaw(this._magisterObj,m));return _results}.call(_this),pushMessage=_helpers.asyncResultWaiter(messages.length,function(r){return callback(null,r)}),_results=[],_i=0,_len=messages.length;_len>_i;_i++)m=messages[_i],_results.push(function(m){return url=""+_this._magisterObj._personUrl+"/berichten/"+m.id()+"?berichtSoort="+m.type(),_this._magisterObj.http.get(url,{},function(error,result){var pushPeople;return m._content=EJSON.parse(result.content).Inhoud,download?(pushPeople=_helpers.asyncResultWaiter(m.recipients().length+1,function(){return pushMessage(m)}),_this._magisterObj.fillPersons(m.recipients(),function(e,r){return m._recipients=r,pushPeople(r)}),_this._magisterObj.fillPersons(m.sender(),function(e,r){return m._sender=r,pushPeople(r)})):pushMessage(m)})}(m));return _results}}(this)))},MessageFolder.prototype.messageFolders=function(query,callback){var _ref;return callback=null!=(_ref=null!=callback?callback:query)?_ref:function(){},null!=callback?this._magisterObj.http.get(""+this._magisterObj._personUrl+"/berichten/mappen?parentId="+this.id(),{},function(_this){return function(error,result){var mF,messageFolders;return null!=error?callback(error,null):(messageFolders=function(){var _i,_len,_ref1,_results;for(_ref1=EJSON.parse(result.content).Items,_results=[],_i=0,_len=_ref1.length;_len>_i;_i++)mF=_ref1[_i],_results.push(MessageFolder._convertRaw(this._magisterObj,mF));return _results}.call(_this),result=_.isString(query)&&""!==query?_.where(messageFolders,function(mF){return Helpers.contains(mF.name(),query,!0)}):messageFolders,callback(null,result))}}(this)):void 0},MessageFolder.prototype.removeAllMessages=function(){return this._magisterObj.http["delete"](""+this._magisterObj._personUrl+"/berichten/map/"+this.id(),{},function(error){if(null!=error)throw error})},MessageFolder.prototype.createMessageFolder=function(name,callback){var folder;return null==callback&&(callback=function(){}),folder={naam:name,parentId:this.id(),persoonId:this._magisterObj._id},this._magisterObj.http.post(""+this._magisterObj._personUrl+"/berichten/mappen",folder,{},function(_this){return function(error,result){return null!=error?callback(error,null):callback(null,MessageFolder._convertRaw(_this._magisterObj,EJSON.parse(result.content)))}}(this))},MessageFolder.prototype.remove=function(){return this._magisterObj.http.put(""+this._magisterObj._personUrl+"/berichten/mappen",this._toMagisterStyle(),{},function(e){if(null!=e)throw e})},MessageFolder.prototype._toMagisterStyle=function(){var obj;return obj={},obj.Naam=this._name,obj.OngelezenBerichten=this._unreadMessagesCount,obj.Id=this._id,obj.ParentId=this._parentId,obj},MessageFolder._convertRaw=function(magisterObj,raw){var obj;return obj=new MessageFolder(magisterObj),obj._name=raw.Naam,obj._unreadMessagesCount=raw.OngelezenBerichten,obj._id=raw.Id,obj._parentId=raw.ParentId,obj},MessageFolder}(),this.Person=function(){function Person(_magisterObj,_type,_firstName,_lastName){if(this._magisterObj=_magisterObj,this._type=_type,this._firstName=_firstName,this._lastName=_lastName,null!=this._firstName&&null!=this._lastName&&_.any(_.toArray(arguments).slice(2),function(a){return null!=a&&!_.isString(a)}))throw new Error("One or more arguments is not a string.");this.id=_getset("_id"),this.type=_getset("_type",function(_this){return function(val){return _this._type=Person._convertType(val,!0)}}(this),Person._convertType),this.firstName=_getset("_firstName"),this.lastName=_getset("_lastName"),this.namePrefix=_getset("_namePrefix"),this.fullName=_getset("_fullName"),this.description=_getset("_description"),this.group=_getset("_group"),this.teacherCode=_getset("_teacherCode"),this.emailAddress=_getset("_emailAddress")}return Person.prototype._toMagisterStyle=function(){var obj;return obj={},obj.Id=this._id,obj.Type=this._type,obj.Voornaam=this._firstName,obj.Achternaam=this._lastName,obj.Tussenvoegsel=this._namePrefix,obj.Naam=this._fullName,obj.Omschrijving=this._description,obj.Groep=this._group,obj.Docentcode=this._teacherCode,obj.Emailadres=this._emailAddress,obj},Person._convertRaw=function(magisterObj,raw){var obj,_ref;return obj=new Person(magisterObj,raw.Type,raw.Voornaam,raw.Achternaam),obj._id=raw.Id,obj._namePrefix=raw.Tussenvoegsel,obj._fullName=raw.Naam,obj._description=null!=(_ref=raw.Omschrijving)?_ref:raw.Naam,obj._group=raw.Groep,obj._teacherCode=raw.Docentcode,obj._emailAddress=raw.Emailadres,obj},Person._convertType=function(original,setter){if(null==setter&&(setter=!0),setter){if(_.isNumber(original)){if(!_.contains([1,3,4,8],original))throw new Error('Invalid value: "'+original+'".');return original}switch(original.toLowerCase()){case"group":return 1;case"teacher":return 3;case"pupil":return 4;case"project":return 8;default:throw new Error('Invalid value: "'+original+'".')}}else switch(original){case 1:return"group";case 3:return"teacher";case 4:return"pupil";case 8:return"project";default:return void 0}},Person}(),this.ProfileInfo=function(){function ProfileInfo(_magisterObj,_firstName,_lastName,_birthDate){this._magisterObj=_magisterObj,this._firstName=_firstName,this._lastName=_lastName,this._birthDate=_birthDate,this.id=_getset("_id"),this.officialFirstNames=_getset("_officialFirstNames"),this.initials=_getset("_initials"),this.namePrefix=_getset("_namePrefix"),this.officialSurname=_getset("_officialSurname"),this.birthSurname=_getset("_birthSurname"),this.birthNamePrefix=_getset("_birthNamePrefix"),this.useBirthname=_getset("_useBirthname"),this.firstName=_getset("_firstName"),this.lastName=_getset("_lastName")}return ProfileInfo.prototype.profilePicture=function(width,height,crop){return null==width&&(width=640),null==height&&(height=640),null==crop&&(crop=!1),""+this._profilePicture+"?width="+width+"&height="+height+"&crop="+crop},ProfileInfo._convertRaw=function(magisterObj,raw){var foto,obj;return foto=magisterObj.magisterSchool.url+_.find(raw.Links,{Rel:"Foto"}).Href,raw=raw.Persoon,obj=new ProfileInfo(magisterObj,raw.Roepnaam,raw.Achternaam,new Date(Date.parse(raw.Geboortedatum))),obj._id=raw.Id,obj._officialFirstNames=raw.OfficieleVoornamen,obj._initials=raw.Voorletters,obj._namePrefix=raw.Tussenvoegsel,obj._officialSurname=raw.OfficieleAchternaam,obj._birthSurname=raw.GeboorteAchternaam,obj._birthNamePrefix=raw.GeboortenaamTussenvoegsel,obj._useBirthname=raw.GebruikGeboortenaam,obj._profilePicture=foto,obj},ProfileInfo}(),this.MagisterSchool=function(){function MagisterSchool(name,url){this.name=name,this.url=url}return MagisterSchool.getSchools=function(query,callback){return null==query||_helpers.trim(query).length<3?[]:(new MagisterHttp).get("https://schoolkiezer.magister.net/home/query?filter="+query,{},function(_this){return function(error,result){var s;return null!=error?callback(error,null):callback(null,function(){var _i,_len,_ref,_results;for(_ref=EJSON.parse(result.content),_results=[],_i=0,_len=_ref.length;_len>_i;_i++)s=_ref[_i],_results.push(this._convertRaw(s));return _results}.call(_this))}}(this))},MagisterSchool._convertRaw=function(raw){return new MagisterSchool(raw.Licentie,"https://"+raw.Url.slice(5))},MagisterSchool}(),this.StudyGuide=function(){function StudyGuide(_magisterObj){this._magisterObj=_magisterObj,this.id=_getset("_id"),this.from=_getset("_from"),this.to=_getset("_to"),this.classCodes=_getset("_classCodes"),this.name=_getset("_name"),this.archived=_getset("_archived")}return StudyGuide.prototype.parts=function(callback){return null!=callback?this._magisterObj.http.get(""+this._magisterObj._pupilUrl+"/studiewijzers/"+this.id(),{},function(_this){return function(error,result){var id,p,pushResult,_i,_len,_ref,_results;if(null!=error)return callback(error,null);for(result=EJSON.parse(result.content).Onderdelen.Items,pushResult=_helpers.asyncResultWaiter(result.length,function(r){return callback(null,r)}),_ref=function(){var _j,_len,_results1;for(_results1=[],_j=0,_len=result.length;_len>_j;_j++)p=result[_j],_results1.push(p.Id);return _results1}(),_results=[],_i=0,_len=_ref.length;_len>_i;_i++)id=_ref[_i],_results.push(_this._magisterObj.http.get(""+_this._magisterObj._pupilUrl+"/studiewijzers/"+_this.id()+"/onderdelen/"+id,{},function(error,result){return pushResult(StudyGuidePart._convertRaw(_this._magisterObj,EJSON.parse(result.content)))}));return _results}}(this)):void 0},StudyGuide._convertRaw=function(magisterObj,raw){var obj;return obj=new StudyGuide(magisterObj),obj._id=raw.Id,obj._from=new Date(Date.parse(raw.Van)),obj._to=new Date(Date.parse(raw.TotEnMet)),obj._classCodes=raw.VakCodes,obj._name=raw.Titel,obj._archived=raw.InLeerlingArchief,obj},StudyGuide}(),this.StudyGuidePart=function(){function StudyGuidePart(_magisterObj){this._magisterObj=_magisterObj,this.id=_getset("_id"),this.from=_getset("_from"),this.to=_getset("_to"),this.name=_getset("_name"),this.description=_getset("_description",null,function(x){return null!=x?x.replace(/<br ?\/?>/g,"\n").replace(/(<[^>]*>)|(&nbsp;)/g,""):x}),this.visible=_getset("_visible"),this.number=_getset("_number"),this.files=_getset("_files")}return StudyGuidePart._convertRaw=function(magisterObj,raw){var f,obj;return obj=new StudyGuidePart(magisterObj),obj._id=raw.Id,obj._from=new Date(Date.parse(raw.Van)),obj._to=new Date(Date.parse(raw.TotEnMet)),obj._name=raw.Titel,obj._description=raw.Omschrijving,obj._visible=raw.IsZichtbaar,obj._number=raw.Volgnummer,obj._files=function(){var _i,_len,_ref,_results;for(_ref=raw.Bronnen,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)f=_ref[_i],_results.push(File._convertRaw(magisterObj,void 0,f));return _results}(),obj},StudyGuidePart}(),this._helpers=function(){function _helpers(){}return _helpers.addZero=function(original){return 10>original?"0"+original:original.toString()},_helpers.toUtcString=function(original){return new moment(original).format("YYYY-MM-DDTHH:mm:ss.0000000[Z]")},_helpers.pushMore=function(arr,items){return[].push.apply(arr,items),arr},_helpers.contains=function(original,query,ignoreCasing){return null==ignoreCasing&&(ignoreCasing=!1),ignoreCasing?original.toUpperCase().indexOf(query.toUpperCase())>=0:original.indexOf(query)>=0},_helpers.asyncResultWaiter=function(amount,callback){var left,results;return 0===amount&&callback([]),results=[],left=amount,function(result){return _.isArray(result)?(_helpers.pushMore(results,result),left-=result.length):(results.push(result),left--),0===left?callback(results):void 0}},_helpers.trim=function(original){return null==original||0===original.length?"":_.isFunction(String.prototype.trim)?original.trim():original.replace(/^\s+|\s+$/g,"")},_helpers.saveFile=function(rawData,mime,name){try{return saveAs(new Blob([rawData],{type:mime}),name)}catch(_error){}},_helpers.urlDateConvert=function(date){return""+date.getUTCFullYear()+"-"+_helpers.addZero(date.getMonth()+1)+"-"+_helpers.addZero(date.getDate())},_helpers.date=function(date){return new Date(date.getUTCFullYear(),date.getMonth(),date.getDate())},_helpers}(),this._getset=function(varName,setter,getter){return function(newVar){if(null!=newVar){if(!_.isFunction(setter))throw new Error("Changes on this property aren't allowed");setter(newVar,!0)}return _.isFunction(getter)?getter(this[varName],!1):this[varName]}},null==Array.isArray&&(_.isArray=jQuery.isArray=Array.isArray=function(x){return Object.prototype.toString.call("[object Array]"===x)}),!function(a){"use strict";if(a.URL=a.URL||a.webkitURL,a.Blob&&a.URL)try{return void new Blob}catch(b){}var c=a.BlobBuilder||a.WebKitBlobBuilder||a.MozBlobBuilder||function(a){var b=function(a){return Object.prototype.toString.call(a).match(/^\[object\s(.*)\]$/)[1]},c=function(){this.data=[]},d=function(a,b,c){this.data=a,this.size=a.length,this.type=b,this.encoding=c},e=c.prototype,f=d.prototype,g=a.FileReaderSync,h=function(a){this.code=this[this.name=a]},i="NOT_FOUND_ERR SECURITY_ERR ABORT_ERR NOT_READABLE_ERR ENCODING_ERR NO_MODIFICATION_ALLOWED_ERR INVALID_STATE_ERR SYNTAX_ERR".split(" "),j=i.length,k=a.URL||a.webkitURL||a,l=k.createObjectURL,m=k.revokeObjectURL,n=k,o=a.btoa,p=a.atob,q=a.ArrayBuffer,r=a.Uint8Array,s=/^[\w-]+:\/*\[?[\w\.:-]+\]?(?::[0-9]+)?/;for(d.fake=f.fake=!0;j--;)h.prototype[i[j]]=j+1;return k.createObjectURL||(n=a.URL=function(a){var c,b=document.createElementNS("http://www.w3.org/1999/xhtml","a");return b.href=a,"origin"in b||("data:"===b.protocol.toLowerCase()?b.origin=null:(c=a.match(s),b.origin=c&&c[1])),b}),n.createObjectURL=function(a){var c,b=a.type;return null===b&&(b="application/octet-stream"),a instanceof d?(c="data:"+b,"base64"===a.encoding?c+";base64,"+a.data:"URI"===a.encoding?c+","+decodeURIComponent(a.data):o?c+";base64,"+o(a.data):c+","+encodeURIComponent(a.data)):l?l.call(k,a):void 0},n.revokeObjectURL=function(a){"data:"!==a.substring(0,5)&&m&&m.call(k,a)},e.append=function(a){var c=this.data;if(r&&(a instanceof q||a instanceof r)){for(var e="",f=new r(a),i=0,j=f.length;j>i;i++)e+=String.fromCharCode(f[i]);c.push(e)}else if("Blob"===b(a)||"File"===b(a)){if(!g)throw new h("NOT_READABLE_ERR");var k=new g;c.push(k.readAsBinaryString(a))}else a instanceof d?"base64"===a.encoding&&p?c.push(p(a.data)):"URI"===a.encoding?c.push(decodeURIComponent(a.data)):"raw"===a.encoding&&c.push(a.data):("string"!=typeof a&&(a+=""),c.push(unescape(encodeURIComponent(a))))},e.getBlob=function(a){return arguments.length||(a=null),new d(this.data.join(""),a,"raw")},e.toString=function(){return"[object BlobBuilder]"},f.slice=function(a,b,c){var e=arguments.length;return 3>e&&(c=null),new d(this.data.slice(a,e>1?b:this.data.length),c,this.encoding)},f.toString=function(){return"[object Blob]"},f.close=function(){this.size=0,delete this.data},c}(a);a.Blob=function(a,b){var d=b?b.type||"":"",e=new c;if(a)for(var f=0,g=a.length;g>f;f++)e.append(a[f]);return e.getBlob(d)}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content||this),saveAs=void 0;try{saveAs=saveAs||"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob&&navigator.msSaveOrOpenBlob.bind(navigator)||function(a){"use strict";if("undefined"==typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var k=a.document,n=k.createElementNS("http://www.w3.org/1999/xhtml","a"),w="download"in n,x=function(c){var e=k.createEvent("MouseEvents");e.initMouseEvent("click",!0,!1,a,0,0,0,0,0,!1,!1,!1,!1,0,null),c.dispatchEvent(e)},q=a.webkitRequestFileSystem,u=a.requestFileSystem||q||a.mozRequestFileSystem,y=function(c){(a.setImmediate||a.setTimeout)(function(){throw c},0)},r=0,s=function(c){var e=function(){"string"==typeof c?(a.URL||a.webkitURL||a).revokeObjectURL(c):c.remove()};a.chrome?e():setTimeout(e,10)},t=function(c,a,d){a=[].concat(a);for(var b=a.length;b--;){var l=c["on"+a[b]];if("function"==typeof l)try{l.call(c,d||c)}catch(f){y(f)}}},m=function(c,e){var f,p,v,d=this,b=c.type,l=!1,k=function(){t(d,["writestart","progress","write","writeend"])},g=function(){(l||!f)&&(f=(a.URL||a.webkitURL||a).createObjectURL(c)),p?p.location.href=f:void 0==a.open(f,"_blank")&&"undefined"!=typeof safari&&(a.location.href=f),d.readyState=d.DONE,k(),s(f)},h=function(a){return function(){return d.readyState!==d.DONE?a.apply(this,arguments):void 0}},m={create:!0,exclusive:!1};d.readyState=d.INIT,e||(e="download"),w?(f=(a.URL||a.webkitURL||a).createObjectURL(c),n.href=f,n.download=e,x(n),d.readyState=d.DONE,k(),s(f)):(a.chrome&&b&&"application/octet-stream"!==b&&(v=c.slice||c.webkitSlice,c=v.call(c,0,c.size,"application/octet-stream"),l=!0),q&&"download"!==e&&(e+=".download"),("application/octet-stream"===b||q)&&(p=a),u?(r+=c.size,u(a.TEMPORARY,r,h(function(a){a.root.getDirectory("saved",m,h(function(a){var b=function(){a.getFile(e,m,h(function(a){a.createWriter(h(function(b){b.onwriteend=function(b){p.location.href=a.toURL(),d.readyState=d.DONE,t(d,"writeend",b),s(a)},b.onerror=function(){var a=b.error;a.code!==a.ABORT_ERR&&g()},["writestart","progress","write","abort"].forEach(function(a){b["on"+a]=d["on"+a]}),b.write(c),d.abort=function(){b.abort(),d.readyState=d.DONE},d.readyState=d.WRITING}),g)}),g)};a.getFile(e,{create:!1},h(function(a){a.remove(),b()}),h(function(a){a.code===a.NOT_FOUND_ERR?b():g()}))}),g)}),g)):g())},b=m.prototype;return b.abort=function(){this.readyState=this.DONE,t(this,"abort")},b.readyState=b.INIT=0,b.WRITING=1,b.DONE=2,b.error=b.onwritestart=b.onprogress=b.onwrite=b.onabort=b.onerror=b.onwriteend=null,function(a,b){return new m(a,b)}}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content),"undefined"!=typeof module&&null!==module?module.exports=saveAs:"undefined"!=typeof define&&null!==define&&null!=define.amd&&define([],function(){return saveAs})}catch(e){}}).call(this);