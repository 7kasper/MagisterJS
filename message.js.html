<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>message.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AbsenceInfo.html">AbsenceInfo</a><ul class='methods'><li data-type='method'><a href="AbsenceInfo.html#toJSON">toJSON</a></li></ul></li><li><a href="Activity.html">Activity</a><ul class='methods'><li data-type='method'><a href="Activity.html#elements">elements</a></li><li data-type='method'><a href="Activity.html#toJSON">toJSON</a></li></ul></li><li><a href="ActivityElement.html">ActivityElement</a><ul class='methods'><li data-type='method'><a href="ActivityElement.html#_toMagister">_toMagister</a></li><li data-type='method'><a href="ActivityElement.html#signup">signup</a></li><li data-type='method'><a href="ActivityElement.html#toJSON">toJSON</a></li></ul></li><li><a href="AddressInfo.html">AddressInfo</a><ul class='methods'><li data-type='method'><a href="AddressInfo.html#toJSON">toJSON</a></li></ul></li><li><a href="Appointment.html">Appointment</a><ul class='methods'><li data-type='method'><a href="Appointment.html#_toMagister">_toMagister</a></li><li data-type='method'><a href="Appointment.html#attachments">attachments</a></li><li data-type='method'><a href="Appointment.html#remove">remove</a></li><li data-type='method'><a href="Appointment.html#saveChanges">saveChanges</a></li><li data-type='method'><a href="Appointment.html#toJSON">toJSON</a></li></ul></li><li><a href="Assignment.html">Assignment</a><ul class='methods'><li data-type='method'><a href="Assignment.html#toJSON">toJSON</a></li><li data-type='method'><a href="Assignment.html#versions">versions</a></li></ul></li><li><a href="AssignmentVersion.html">AssignmentVersion</a><ul class='methods'><li data-type='method'><a href="AssignmentVersion.html#toJSON">toJSON</a></li></ul></li><li><a href="AuthError.html">AuthError</a><ul class='methods'><li data-type='method'><a href="AuthError.html#toString">toString</a></li></ul></li><li><a href="Class.html">Class</a><ul class='methods'><li data-type='method'><a href="Class.html#toJSON">toJSON</a></li></ul></li><li><a href="Course.html">Course</a><ul class='methods'><li data-type='method'><a href="Course.html#classes">classes</a></li><li data-type='method'><a href="Course.html#grades">grades</a></li><li data-type='method'><a href="Course.html#toJSON">toJSON</a></li></ul></li><li><a href="File.html">File</a><ul class='methods'><li data-type='method'><a href="File.html#_toMagister">_toMagister</a></li><li data-type='method'><a href="File.html#download">download</a></li><li data-type='method'><a href="File.html#remove">remove</a></li><li data-type='method'><a href="File.html#saveChanges">saveChanges</a></li><li data-type='method'><a href="File.html#toJSON">toJSON</a></li></ul></li><li><a href="FileFolder.html">FileFolder</a><ul class='methods'><li data-type='method'><a href="FileFolder.html#files">files</a></li><li data-type='method'><a href="FileFolder.html#toJSON">toJSON</a></li></ul></li><li><a href="Grade.html">Grade</a><ul class='methods'><li data-type='method'><a href="Grade.html#fill">fill</a></li><li data-type='method'><a href="Grade.html#toJSON">toJSON</a></li></ul></li><li><a href="GradePeriod.html">GradePeriod</a><ul class='methods'><li data-type='method'><a href="GradePeriod.html#toJSON">toJSON</a></li></ul></li><li><a href="GradeType.html">GradeType</a><ul class='methods'><li data-type='method'><a href="GradeType.html#toJSON">toJSON</a></li></ul></li><li><a href="Http.html">Http</a><ul class='methods'><li data-type='method'><a href="Http.html#_enqueue">_enqueue</a></li><li data-type='method'><a href="Http.html#_request">_request</a></li><li data-type='method'><a href="Http.html#_setRatelimitTime">_setRatelimitTime</a></li><li data-type='method'><a href="Http.html#delete">delete</a></li><li data-type='method'><a href="Http.html#get">get</a></li><li data-type='method'><a href="Http.html#makeRequest">makeRequest</a></li><li data-type='method'><a href="Http.html#post">post</a></li><li data-type='method'><a href="Http.html#put">put</a></li></ul></li><li><a href="Magister.html">Magister</a><ul class='methods'><li data-type='method'><a href="Magister.html#activities">activities</a></li><li data-type='method'><a href="Magister.html#appointments">appointments</a></li><li data-type='method'><a href="Magister.html#assignments">assignments</a></li><li data-type='method'><a href="Magister.html#children">children</a></li><li data-type='method'><a href="Magister.html#courses">courses</a></li><li data-type='method'><a href="Magister.html#createAppointment">createAppointment</a></li><li data-type='method'><a href="Magister.html#fileFolders">fileFolders</a></li><li data-type='method'><a href="Magister.html#login">login</a></li><li data-type='method'><a href="Magister.html#messageFolders">messageFolders</a></li><li data-type='method'><a href="Magister.html#persons">persons</a></li></ul></li><li><a href="MagisterError.html">MagisterError</a><ul class='methods'><li data-type='method'><a href="MagisterError.html#toString">toString</a></li></ul></li><li><a href="MagisterThing.html">MagisterThing</a><ul class='methods'><li data-type='method'><a href="MagisterThing.html#toJSON">toJSON</a></li></ul></li><li><a href="Message.html">Message</a><ul class='methods'><li data-type='method'><a href="Message.html#_toMagister">_toMagister</a></li><li data-type='method'><a href="Message.html#addRecipient">addRecipient</a></li><li data-type='method'><a href="Message.html#fill">fill</a></li><li data-type='method'><a href="Message.html#remove">remove</a></li><li data-type='method'><a href="Message.html#saveChanges">saveChanges</a></li><li data-type='method'><a href="Message.html#send">send</a></li><li data-type='method'><a href="Message.html#toJSON">toJSON</a></li></ul></li><li><a href="MessageFolder.html">MessageFolder</a><ul class='methods'><li data-type='method'><a href="MessageFolder.html#messages">messages</a></li><li data-type='method'><a href="MessageFolder.html#toJSON">toJSON</a></li></ul></li><li><a href="Person.html">Person</a><ul class='methods'><li data-type='method'><a href="Person.html#_toMagister">_toMagister</a></li><li data-type='method'><a href="Person.html#getFilled">getFilled</a></li><li data-type='method'><a href="Person.html#toJSON">toJSON</a></li></ul></li><li><a href="Privileges.html">Privileges</a></li><li><a href="ProfileInfo.html">ProfileInfo</a><ul class='methods'><li data-type='method'><a href="ProfileInfo.html#address">address</a></li><li data-type='method'><a href="ProfileInfo.html#getFullName">getFullName</a></li><li data-type='method'><a href="ProfileInfo.html#getProfilePicture">getProfilePicture</a></li><li data-type='method'><a href="ProfileInfo.html#settings">settings</a></li><li data-type='method'><a href="ProfileInfo.html#toJSON">toJSON</a></li></ul></li><li><a href="ProfileSettings.html">ProfileSettings</a><ul class='methods'><li data-type='method'><a href="ProfileSettings.html#_toMagister">_toMagister</a></li><li data-type='method'><a href="ProfileSettings.html#changePassword">changePassword</a></li><li data-type='method'><a href="ProfileSettings.html#saveChanges">saveChanges</a></li><li data-type='method'><a href="ProfileSettings.html#toJSON">toJSON</a></li></ul></li><li><a href="School.html">School</a><ul class='methods'><li data-type='method'><a href="School.html#versionInfo">versionInfo</a></li></ul></li><li><a href="SchoolUtility.html">SchoolUtility</a><ul class='methods'><li data-type='method'><a href="SchoolUtility.html#toJSON">toJSON</a></li></ul></li><li><a href="global.html#VersionInfo">VersionInfo</a></li></ul><h3>Global</h3><ul><li><a href="global.html#can">can</a></li><li><a href="global.html#getSchools">getSchools</a></li><li><a href="global.html#needs">needs</a></li><li><a href="global.html#VERSION">VERSION</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">message.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* global dedent */

import _ from 'lodash'
import MagisterThing from './magisterThing'
import Person from './person'
import File from './file'
import { cleanHtmlContent, parseDate, toString, cloneClassInstance } from './util'

/**
 * @extends MagisterThing
 */
class Message extends MagisterThing {
	/**
	 * @param {Magister} magister
	 * @param {Object} [raw]
	 */
	constructor(magister, raw) {
		super(magister)

		/**
		 * @type Boolean
		 * @private
		 * @readonly
		 * @default true
		 */
		this._canSend = true
		/**
		 * @type Number
		 * @private
		 * @readonly
		 * @default 1
		 */
		this._type = 1
		/**
		 * @type String
		 * @readonly
		 * @default ''
		 */
		this.subject = ''
		/**
		 * If creating a message, this will be an empty string per default.
		 * When retrieving a message from Magister, this will be `undefined` per
		 * default, you should use `Message#fill` to get the body.
		 *
		 * @type String
		 * @readonly
		 * @default ''
		 */
		this.body = ''
		/**
		 * @type Person[]
		 * @readonly
		 * @default []
		 */
		this.recipients = []

		if (raw != null) {
			this._canSend = false
			this._type = raw.Soort
			this.subject = raw.Onderwerp
			this.body = undefined
			this.recipients = raw.Ontvangers.map(p => new Person(magister, p))

			/**
			 * @type String
			 * @readonly
			 */
			this.id = toString(raw.Id)
			/**
			 * @type String
			 * @readonly
			 */
			this.folderId = toString(raw.MapId)
			/**
			 * @type Person
			 * @readonly
			 */
			this.sender = new Person(magister, raw.Afzender)
			/**
			 * @type Date
			 * @readonly
			 */
			this.sendDate = parseDate(raw.VerstuurdOp)
			/**
			 * @type Date
			 * @readonly
			 */
			this.begin = parseDate(raw.Begin)
			/**
			 * @type Date
			 * @readonly
			 */
			this.end = parseDate(raw.Einde)
			/**
			 * @type Boolean
			 * @readonly
			 */
			this.isRead = raw.IsGelezen
			/**
			 * @type Number
			 * @readonly
			 */
			this.state = raw.Status
			/**
			 * @type Boolean
			 * @readonly
			 */
			this.isFlagged = raw.HeeftPrioriteit
			/**
			 * @type String
			 * @readonly
			 */
			this.summary = cleanHtmlContent(raw.IngekortBericht)

			/**
			 * This will be `undefined` per default, a fill using `Message#fill`
			 * is required to retrieve the attachments for this Message.
			 * @type File[]
			 * @readonly
			 * @default undefined
			 */
			this.attachments = undefined

			/**
			 * @type String
			 * @private
			 * @readonly
			 */
			this._url = `${magister._personUrl}/berichten/${this.id}`
		}
	}

	/**
	 * @type String
	 * @readonly
	 * @default 'message'
	 */
	get type() {
		switch (this._type) {
		case 1:  return 'message'
		case 2:  return 'alert'
		default: return 'unknown'
		}
	}

	/**
	 * @param {Person|Person[]} recipients
	 */
	addRecipient(recipients) {
		if (!Array.isArray(recipients)) {
			recipients = [ recipients ]
		}

		if (!recipients.every(x => x instanceof Person)) {
			throw new Error('`recipients` should be a Person or an Array of Persons')
		}

		this.recipients = this.recipients.concat(recipients)
	}

	createReplyMessage(content = '') {
		const message = cloneClassInstance(this)

		message.body = dedent`
			${content}

			---------------
			${this.toString()}
		`
		message.subject = `RE: ${this.subject}`
		message.recipients = [ this.sender ]

		message._type = 1
		message._canSend = true

		return message
	}

	createReplyToAllMessage(content = '') {
		const message = cloneClassInstance(this)

		message.body = dedent`
			${content}

			---------------
			${this.toString()}
		`
		message.subject = `RE: ${this.subject}`
		message.recipients =
			_.chain(this.recipients)
			.reject({ id: this._magister.profileInfo.id })
			.push(this.sender)
			.value()

		message._type = 1
		message._canSend = true

		return message
	}

	createForwardMessage(content = '') {
		const message = cloneClassInstance(this)

		message.body = dedent`
			${content}

			---------------
			${this.toString()}
		`
		message.subject = `FW: ${this.subject}`

		message._type = 1
		message._canSend = true

		return message
	}

	/**
	 * @param {Boolean} [fillPersons=false]
	 * @return {Promise&lt;Message>}
	 */
	fill(fillPersons = false) {
		if (this._filled &amp;&amp; (this._filledPersons || !fillPersons)) {
			return Promise.resolve(this)
		}

		const url = `${this._magister._personUrl}/berichten/${this.id}?berichtSoort=${this._type}`
		return this._magister.http.get(url)
		.then(res => res.json())
		.then(res => {
			this.body = cleanHtmlContent(res.Inhoud)
			this.attachments = (res.Bijlagen || []).map(a => new File(this._magister, undefined, a))

			if (fillPersons) {
				let promises = []

				// fill sender
				promises.push(
					this.sender.getFilled()
					.then(r => this.sender = r)
					.catch(() => this.sender)
				)

				// fill recipients
				promises = promises.concat(
					this.recipients.map(r => {
						return r.getFilled()
						.then(x => x)
						.catch(() => r)
					})
				)

				return Promise.all(promises)
			}
		})
		.then(() => {
			this._filled = true
			return this
		})
	}

	// REVIEW
	move(destination) {
		if (_.isObject(destination)) {
			destination = destination.id
		}

		if (this.folderId === destination) {
			return Promise.resolve(undefined)
		}

		this.folderId = destination
		return this.saveChanges()
	}

	/**
	 * @return {Promise&lt;Error|undefined>}
	 */
	remove() {
		return this._magister._privileges.needs('berichten', 'delete')
		.then(() => this._magister.http.delete(this._url))
	}

	/**
	 * Update the server to reflect the changes made on the properties of this
	 * Message instance.
	 * @return {Promise&lt;undefined>}
	 */
	saveChanges() {
		return this._magister._privileges.needs('berichten', 'update')
		.then(() => this._magister.http.put(this._url, this._toMagister()))
		.then(() => undefined)
	}

	/**
	 * @return {Promise&lt;Message>}
	 */
	send() {
		const reject = message => Promise.reject(new Error(message))

		if (!this._canSend) {
			return reject('message is marked as unsendable')
		} else if (this.recipients.length === 0) {
			return reject('message doesn\'t have recipients')
		} else if (this.subject.length === 0) {
			return reject('subject is empty')
		}

		return this._magister._privileges.needs('berichten', 'create')
		.then(() => this._magister.http.post(
			`${this._magister._personUrl}/berichten`,
			this._toMagister()
		))
		.then(() => this)
	}

	toString() {
		return dedent`
			&lt;b>Van:&lt;/b> ${this.sender.description}
			&lt;b>Verzonden:&lt;/b> ${this.sendDate.toLocaleString()}
			&lt;b>Aan:&lt;/b> ${this.recipients.map(p => p.description).join(', ')}
			&lt;b>Onderwerp:&lt;/b> ${this.subject}

			${this.body}
		`
	}

	/**
	 * @private
	 * @return {Object}
	 */
	_toMagister() {
		return {
			Id: this.id,
			Inhoud: this.body,
			MapId: this.folderId, // number?
			Onderwerp: this.subject,
			Ontvangers: this.recipients.map(p => p._toMagister()),
			VerstuurdOp: this.sendDate || new Date(),
			Begin: this.begin,
			Einde: this.end,
			IsGelezen: this.isRead,
			Status: this.state,
			HeeftPrioriteit: this.isFlagged,
			Soort: this._type,
		}
	}
}

export default Message
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Mon Nov 05 2018 13:20:53 GMT+0100 (Central European Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>


</body>
</html>
