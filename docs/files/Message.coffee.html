<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Message.coffee - Magister.js Docs</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="http://i.imgur.com/Lrg80ax.png" title="Magister.js Docs"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.22.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/AbsenceInfo.html">AbsenceInfo</a></li>
                                <li><a href="../classes/AddressInfo.html">AddressInfo</a></li>
                                <li><a href="../classes/Appointment.html">Appointment</a></li>
                                <li><a href="../classes/Assignment.html">Assignment</a></li>
                                <li><a href="../classes/AssignmentVersion.html">AssignmentVersion</a></li>
                                <li><a href="../classes/Class.html">Class</a></li>
                                <li><a href="../classes/Course.html">Course</a></li>
                                <li><a href="../classes/DigitalSchoolUtility.html">DigitalSchoolUtility</a></li>
                                <li><a href="../classes/File.html">File</a></li>
                                <li><a href="../classes/FileFolder.html">FileFolder</a></li>
                                <li><a href="../classes/Grade.html">Grade</a></li>
                                <li><a href="../classes/GradePeriod.html">GradePeriod</a></li>
                                <li><a href="../classes/GradeType.html">GradeType</a></li>
                                <li><a href="../classes/Magister.html">Magister</a></li>
                                <li><a href="../classes/MagisterSchool.html">MagisterSchool</a></li>
                                <li><a href="../classes/Message.html">Message</a></li>
                                <li><a href="../classes/MessageFolder.html">MessageFolder</a></li>
                                <li><a href="../classes/Person.html">Person</a></li>
                                <li><a href="../classes/ProfileInfo.html">ProfileInfo</a></li>
                                <li><a href="../classes/ProfileSettings.html">ProfileSettings</a></li>
                                <li><a href="../classes/StudyGuide.html">StudyGuide</a></li>
                                <li><a href="../classes/StudyGuidePart.html">StudyGuidePart</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/Magister.html">Magister</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: Message.coffee</h1>

<div class="file">
    <pre class="code prettyprint linenums">
root = (module?.exports ? this.Magister ?= {})

messageFolder = (magisterObj, x) -&gt;
	switch x
		when 1 then magisterObj.inbox()
		when 2 then magisterObj.sentItems()
		when 3 then magisterObj.bin()
		when 4 then magisterObj.alerts()

		# TODO: allow search with id to &#x60;Magister::messageFolders&#x60; so that we can
		# give back the real messagefolder.
		else root.MessageFolder._convertRaw { Id: x }

#TODO: Support sending Attachments.
###*
# A Magister message.
#
# @class Message
# @param _magisterObj {Magister} A Magister object this Message is child of.
# @constructor
###
class root.Message
	constructor: (@_magisterObj) -&gt;
		throw new Error &quot;Magister instance is null!&quot; unless @_magisterObj?
		@_magisterObj._forceReady()

		@_canSend = yes
		@_sender = @_magisterObj.profileInfo()
		@_recipients = []
		@_sendDate = new Date()
		@_isRead = no
		@_type = 1
		@_subject = &quot;&quot;
		@_body = &quot;&quot;

		###*
		# @property id
		# @final
		# @type Number
		###
		@id = root._getset &quot;_id&quot;
		###*
		# @property body
		# @type String
		# @default &quot;&quot;
		###
		@body = root._getset &quot;_body&quot;, ((x) =&gt; @_body = (x ? &quot;&quot;).replace &quot;\n&quot;, &quot;&lt;br&gt;&quot;), root._helpers.cleanHtmlContent
		###*
		# @property attachments
		# @final
		# @type File[]
		###
		@attachments = root._getset &quot;_attachments&quot;
		###*
		# The MessageFolder this Message in, changing this will move the Message.
		# @property messageFolder
		# @type MessageFolder
		###
		@messageFolder = root._getset &quot;_folderId&quot;, ((x) =&gt; @move x), (x) =&gt; messageFolder @_magisterObj, x
		###*
		# @property subject
		# @type String
		# @default &quot;&quot;
		###
		@subject = root._getset &quot;_subject&quot;, (x) =&gt; @_subject = x
		###*
		# @property sender
		# @final
		# @type Person
		###
		@sender = root._getset &quot;_sender&quot;
		###*
		# @property recipients
		# @final
		# @type Person[]
		# @default []
		###
		@recipients = root._getset &quot;_recipients&quot;
		###*
		# @property sendDate
		# @final
		# @type Date|undefined
		# @default new Date()
		###
		@sendDate = root._getset &quot;_sendDate&quot;
		###*
		# @property begin
		# @final
		# @type Date|undefined
		###
		@begin = root._getset &quot;_begin&quot;
		###*
		# @property end
		# @final
		# @type Date|undefined
		###
		@end = root._getset &quot;_end&quot;
		###*
		# @property isRead
		# @type Boolean
		# @default false
		###
		@isRead = root._getset &quot;_isRead&quot;, (x) =&gt;
			return if @_isRead is x or @_canSend

			@_isRead = x
			@_update()
		###*
		# @property state
		# @final
		# @type Number
		###
		@state = root._getset &quot;_state&quot;
		###*
		# @property isFlagged
		# @final
		# @type Boolean
		###
		@isFlagged = root._getset &quot;_isFlagged&quot;
		###*
		# @property type
		# @final
		# @type Number
		###
		@type = root._getset &quot;_type&quot;

	_tasks: 0
	_sendAfterFinished: no
	_finishedCallback: null
	_isWorking: -&gt; @_tasks isnt 0
	_tickDown: -&gt; if --@_tasks is 0 and @_sendAfterFinished then @send @_finishedCallback
	_reset: -&gt; @_tasks = 0; @_sendAfterFinished = no

	###*
	# Adds (a) recipient(s) to the current Message.
	#
	# @method addRecipient
	# @param recipient {String|Person|Number|String[]|Person[]|Number[]} The recipient(s) to add.
	# @param [type] {String|Number} The type of the recipient, if none is provided and recipient is a String it will search for persons.
	###
	addRecipient: (recipient, type) -&gt;
		if _.isString recipient
			@_tasks++
			@_magisterObj.getPersons recipient, type, (e, r) =&gt;
				if e? then @_reset(); throw e
				else if r.length isnt 0
					@recipients().push r[0]
					@_tickDown()
				else if type? then @_reset(); throw new Error &quot;Couldn&#x27;t find a person with the type: \&quot;#{type}\&quot; and with the query: \&quot;#{recipient}\&quot;&quot;
				else @_reset(); throw new Error &quot;Couldn&#x27;t find a person with the query: \&quot;#{recipient}\&quot;&quot;

		else if _.isArray recipient
			@addRecipient p, type for p in recipient

		else if _.isObject recipient
			@recipients().push recipient

		else if _.isNumber recipient
			person = new root.Person @_magisterObj, &#x27;&#x27;, &#x27;&#x27;
			person._id = recipient
			person._type = 3
			@recipients().push person

		else
			@_reset()
			throw new Error &quot;Expected recipient to be a String, Number, or an Object, got a(n) #{root._helpers.typeof recipient}&quot;

		undefined

	###*
	# Creates a new Message that replies to the sender of the current Message.
	#
	# @method createReplyMessage
	# @param [newContent] {String} The string to prepend the current message with.
	# @return {Message} The newely created Message.
	###
	createReplyMessage: (newContent) -&gt;
		subject = if @subject().indexOf(&quot;RE: &quot;) isnt 0 then &quot;RE: #{@subject()}&quot; else subject()

		msg = new root.Message @_magisterObj
		msg._sender = @_sender
		msg._folderId = @_folderId
		msg._isFlagged = @_isFlagged
		msg._id = @_id
		msg._body = (if newContent? then &quot;#{newContent}&lt;br&gt;&lt;br&gt;---------------&lt;br&gt;&quot; else &quot;&quot;) + &quot;&lt;b&gt;Van:&lt;/b&gt; #{@sender().description()}&lt;br&gt;&lt;b&gt;Verzonden:&lt;/b&gt; #{@sendDate().toLocaleString()}&lt;br&gt;&lt;b&gt;Aan:&lt;/b&gt; #{@recipients().map((x) -&gt; x.fullName()).join &quot;, &quot;}&lt;br&gt;&lt;b&gt;Onderwerp:&lt;/b&gt; #{@subject()}&lt;br&gt;&lt;br&gt;\&quot;#{@body()}\&quot;&lt;br&gt;&lt;br&gt;&quot;
		msg._subject = subject
		msg._recipients = [ @sender() ]

		msg

	###*
	# Creates a new Message that replies to the sender and recipients of the current Message.
	#
	# @method createReplyToAllMessage
	# @param [newContent] {String} The string to prepend the current message with.
	# @return {Message} The newely created Message.
	###
	createReplyToAllMessage: (newContent) -&gt;
		subject = if @subject().indexOf(&quot;RE: &quot;) isnt 0 then &quot;RE: #{@subject()}&quot; else subject()

		msg = new root.Message @_magisterObj
		msg._sender = @_sender
		msg._folderId = @_folderId
		msg._isFlagged = @_isFlagged
		msg._id = @_id
		msg._body = (if newContent? then &quot;#{newContent}&lt;br&gt;&lt;br&gt;---------------&lt;br&gt;&quot; else &quot;&quot;) + &quot;&lt;b&gt;Van:&lt;/b&gt; #{@sender().description()}&lt;br&gt;&lt;b&gt;Verzonden:&lt;/b&gt; #{@sendDate().toLocaleString()}&lt;br&gt;&lt;b&gt;Aan:&lt;/b&gt; #{@recipients().map((x) -&gt; x.fullName()).join &quot;, &quot;}&lt;br&gt;&lt;b&gt;Onderwerp:&lt;/b&gt; #{@subject()}&lt;br&gt;&lt;br&gt;\&quot;#{@body()}\&quot;&lt;br&gt;&lt;br&gt;&quot;
		msg._subject = subject
		msg._recipients = _.reject(@recipients(), (x) -&gt; x.id() is @_magisterObj.profileInfo().id()).concat [ @sender() ]

		msg

	###*
	# Creates a new Message that forwards the current Message.
	#
	# @method createForwardMessage
	# @param [newContent] {String} The string to prepend the current message with.
	# @return {Message} The newely created Message.
	###
	createForwardMessage: (newContent) -&gt;
		subject = if @subject().indexOf(&quot;FW: &quot;) isnt 0 then &quot;FW: #{@subject()}&quot; else subject()

		msg = new root.Message @_magisterObj
		msg._sender = @_sender
		msg._folderId = @_folderId
		msg._isFlagged = @_isFlagged
		msg._id = @_id
		msg._body = (if newContent? then &quot;#{newContent}&lt;br&gt;&lt;br&gt;---------------&lt;br&gt;&quot; else &quot;&quot;) + &quot;&lt;b&gt;Van:&lt;/b&gt; #{@sender().description()}&lt;br&gt;&lt;b&gt;Verzonden:&lt;/b&gt; #{@sendDate().toLocaleString()}&lt;br&gt;&lt;b&gt;Aan:&lt;/b&gt; #{@recipients().map((x) -&gt; x.fullName()).join &quot;, &quot;}&lt;br&gt;&lt;b&gt;Onderwerp:&lt;/b&gt; #{@subject()}&lt;br&gt;&lt;br&gt;\&quot;#{@body()}\&quot;&lt;br&gt;&lt;br&gt;&quot;
		msg._subject = subject

		msg

	###*
	# Sends the current Message. Sending will be delayed if there are processes running in the background.
	#
	# @method send
	# @param [cb] {Function} An optional callback.
	# 	@param [cb.error] {Object} An error, if it exists.
	# 	@param [cb.result] {Message} The sent message.
	# @return {Boolean} False if the sending is delayed, otherwise true.
	###
	send: (cb) -&gt;
		if @_isWorking()
			@_sendAfterFinished = yes
			@_finishedCallback = cb
			no
		else
			error = (str) -&gt; root._helpers.defer cb, new Error(str), null
			unless @_canSend
				error &#x27;this message is marked as unsendable&#x27;
				return undefined
			unless @recipients()? and @sender()?
				error &#x27;both sender and recipients must have a value&#x27;
				return undefined
			if _.isEmpty @subject()
				error &quot;subject can&#x27;t be empty&quot;
				return undefined

			@_magisterObj.http.post &quot;#{@_magisterObj._personUrl}/berichten&quot;, @_toMagisterStyle(), {}, (e, r) =&gt;
				if e? then cb? e, null
				else cb? null, this

			yes

	###*
	# Move the current message to the given position.
	#
	# @method move
	# @param destination {Number|MessageFolder} The ID of a MessageFolder or the MessageFolder itself where to move this Message to.
	###
	move: (destination) -&gt;
		destination = destination.id() if _.isObject(destination)
		throw new Error(&quot;Could not resolve MessageFolder form the given destination.&quot;) unless _.isNumber(destination)
		return if @_folderId is destination

		@_folderId = destination
		@_update()

	###*
	# WARNING. Removes the current Message.
	#
	# @method remove
	# @param [callback] {Function} An optional callback.
	# 	@param [callback.error] {Object} An error, if it exists.
	###
	remove: (cb) -&gt; @_magisterObj.http.delete &quot;#{@_magisterObj._personUrl}/berichten/#{@id()}&quot;, {}, (error, result) -&gt; cb? error

	###*
	# Downloads extra info, if it&#x27;s not downloaded yet and fills the current
	# message with it.
	#
	# @method fillMessage
	# @param {Boolean} [fillPersons=false] Whether or not to download the users from the server.
	# @param callback {Function} A standard callback.
	# 	@param [callback.error] {Object} The error, if it exists.
	# 	@param [callback.result] {Message} The current message filled with the newely downloaded info.
	###
	fillMessage: -&gt;
		fillPersons = _.first(arguments) ? no
		callback = _.last arguments

		if @_filled
			root._helpers.defer callback, null, this
		else if callback?
			@_magisterObj.http.get @_fillUrl, {}, (error, result) =&gt;
				if error? then callback? error, null
				else
					parsed = JSON.parse(result.content)
					@_body = parsed.Inhoud
					@_attachments = (root.File._convertRaw(@_magisterObj, undefined, a) for a in (parsed.Bijlagen ? []))

					if fillPersons
						pushPeople = root._helpers.asyncResultWaiter m.recipients().length + 1, =&gt;
							@_filled = yes
							callback? null, this

						@_magisterObj.fillPersons m.recipients(), (e, r) -&gt;
							m._recipients = r
							pushPeople r

						@_magisterObj.fillPersons m.sender(), (e, r) -&gt;
							m._sender = r
							pushPeople r
					else
						@_filled = yes
						callback? null, this

	_update: -&gt; @_magisterObj.http.put &quot;#{@_magisterObj._personUrl}/berichten/#{@id()}?berichtSoort=#{@type()}&quot;, @_toMagisterStyle(), {}, (-&gt;)

	_toMagisterStyle: -&gt;
		obj = {}

		obj.Id = @_id
		obj.Inhoud = @_body
		obj.MapId = @_folderId
		obj.Onderwerp = @_subject
		#obj.Afzender = @_sender._toMagisterStyle()
		obj.Ontvangers = ( p._toMagisterStyle() for p in @_recipients )
		obj.VerstuurdOp = @_sendDate
		obj.Begin = @_begin
		obj.Einde = @_end
		obj.IsGelezen = @_isRead
		obj.Status = @_state
		obj.HeeftPrioriteit = @_isFlagged
		obj.Soort = @_type

		obj

	@_convertRaw: (magisterObj, raw) -&gt;
		obj = new root.Message magisterObj

		obj._id = raw.Id
		obj._body = raw.Inhoud ? &quot;&quot;
		obj._folderId = raw.MapId
		obj._subject = raw.Onderwerp
		obj._sender = root.Person._convertRaw magisterObj, raw.Afzender
		obj._recipients = ( root.Person._convertRaw magisterObj, o for o in (raw.Ontvangers ? []) )
		obj._sendDate = root._helpers.parseDate raw.VerstuurdOp
		obj._begin = root._helpers.parseDate raw.Begin
		obj._end = root._helpers.parseDate raw.Einde
		obj._isRead = raw.IsGelezen
		obj._state = raw.Status
		obj._isFlagged = raw.HeeftPrioriteit
		obj._type = raw.Soort
		obj._canSend = no

		obj._fillUrl = &quot;#{magisterObj._personUrl}/berichten/#{obj._id}?berichtSoort=#{obj._type}&quot;

		obj

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
